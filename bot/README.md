# Telegram-бот для трекера подписок

Бот уведомляет за 2 дня до списания и позволяет просматривать, добавлять и удалять подписки из Telegram. Данные синхронизируются с тем же Firebase, что и веб-приложение.

**Где запускать:** GitHub хранит только код и не запускает приложения 24/7. Чтобы бот работал круглосуточно, разверните его в облаке — проще всего через [Railway](#деплой-на-railway).

## Возможности

- **Уведомления** — за 2 дня до даты списания бот присылает напоминание (ежедневная проверка в 9:00 по локальному времени).
- **Список подписок** — команда `/list` выводит все подписки в хронологическом порядке (от ближайшего списания к дальнему).
- **Добавление** — команда `/add` запускает пошаговый ввод: название, цена, валюта, дата следующего списания, период (monthly/yearly).
- **Удаление** — команда `/delete` показывает список с кнопками или можно отправить `/delete_3` (номер из списка).
- **Привязка** — в веб-приложении нажмите «Привязать Telegram», получите код и отправьте боту: `/link_КОД`.

## Установка

1. Создайте бота в Telegram через [@BotFather](https://t.me/BotFather), получите токен.

2. В [Firebase Console](https://console.firebase.google.com/) → Настройки проекта → Служебные учетные записи → «Создать закрытый ключ». Сохраните JSON-файл в папку `bot/` как `service-account.json` (или укажите путь в переменной окружения).

3. Обновите правила Firestore: добавьте правило для коллекции `link_codes` (см. основной `FIREBASE_SETUP.md` в корне проекта).

4. В папке `bot/` создайте файл `.env` по образцу `.env.example`:

```bash
cp .env.example .env
```

Заполните в `.env`:

- `TELEGRAM_BOT_TOKEN` — токен от BotFather.
- `GOOGLE_APPLICATION_CREDENTIALS` — путь к `service-account.json` (например `./service-account.json`).

Либо вместо файла можно задать переменную `FIREBASE_SERVICE_ACCOUNT_JSON` — строка с содержимым JSON сервисного аккаунта.

5. Установите зависимости и запустите:

```bash
cd bot
npm install
npm start
```

Для уведомлений бот должен работать постоянно (сервер, VPS или облачная функция с расписанием).

---

## Деплой на Railway

[Railway](https://railway.app) даёт возможность запускать бота 24/7, подключая репозиторий с GitHub. Есть бесплатный месячный лимит.

### Шаги

1. **Репозиторий на GitHub**  
   Код бота уже в папке `bot/` вашего репозитория. Запушьте изменения, если ещё не сделали этого.

2. **Регистрация в Railway**  
   Зайдите на [railway.app](https://railway.app), нажмите **Login** и войдите через **GitHub**.

3. **Новый проект из репозитория**  
   - **New Project** → **Deploy from GitHub repo**  
   - Выберите репозиторий `subscription-tracker-simple` (или как у вас называется проект)  
   - Railway создаст сервис из репозитория.

4. **Корневая папка сервиса — `bot`**  
   - Откройте созданный сервис  
   - Вкладка **Settings** → секция **Build**  
   - Поле **Root Directory**: укажите `bot` и сохраните.  
   Так Railway будет собирать и запускать приложение из папки с `package.json` бота.

5. **Переменные окружения**  
   Вкладка **Variables** того же сервиса. Добавьте:

   | Переменная | Значение |
   |------------|----------|
   | `TELEGRAM_BOT_TOKEN` | Токен от [@BotFather](https://t.me/BotFather) |
   | `FIREBASE_SERVICE_ACCOUNT_JSON` | Весь JSON сервисного аккаунта Firebase **в одну строку** (без переносов). Скопируйте содержимое файла ключа из Firebase Console → Настройки проекта → Служебные учётные записи → Создать закрытый ключ. Можно сжать в одну строку через любой JSON minifier. |

   Опционально:
   - `TZ` — часовой пояс для уведомлений, например `Europe/Moscow`.

   На Railway нельзя загрузить файл ключа, поэтому используется только переменная `FIREBASE_SERVICE_ACCOUNT_JSON`.

6. **Деплой**  
   После сохранения переменных Railway пересоберёт и запустит бота. В логах сервиса (**Deployments** → выберите деплой → **View Logs**) должно появиться сообщение вроде: «Бот запущен. Ожидаю сообщения...».

7. **Проверка**  
   Напишите боту в Telegram команду `/start`. Если ответ пришёл — бот работает в облаке.

### Важно

- Не добавляйте `service-account.json` в репозиторий. На Railway используется только переменная `FIREBASE_SERVICE_ACCOUNT_JSON`.
- Бесплатный план Railway ограничен по использованию; при превышении лимита сервис может остановиться до следующего месяца.

---

## Команды бота

| Команда | Описание |
|--------|----------|
| `/start` | Приветствие и подсказки |
| `/link_КОД` | Привязать чат к аккаунту (код из веб-приложения) |
| `/list` | Список подписок по дате списания |
| `/add` | Добавить подписку (пошаговый ввод) |
| `/delete` | Удалить подписку (выбор из списка) |
| `/delete_НОМЕР` | Удалить подписку по номеру из списка (например `/delete_3`) |

## Безопасность

- Файл `service-account.json` и переменные из `.env` не должны попадать в репозиторий. Добавьте в `.gitignore`: `bot/.env`, `bot/service-account.json`.

---

## Ошибка «Не удалось создать код. Проверьте правила Firestore для коллекции link_codes»

Она появляется, когда в веб-приложении нажимаете «Привязать Telegram», а в Firestore ещё нет правил для коллекции `link_codes`.

**Что сделать:**

1. Откройте [Firebase Console](https://console.firebase.google.com/) → ваш проект **lllewellla-subs-tracker**.
2. Слева выберите **Firestore Database** → вкладка **Правила** (Rules).
3. В блоке правил должен быть не только `users`, но и `link_codes`. Если блока `link_codes` нет — добавьте его. Итоговые правила должны выглядеть так:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /link_codes/{code} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read, update, delete: if false;
    }
  }
}
```

4. Нажмите **Опубликовать** (Publish).
5. Обновите страницу веб-приложения и снова нажмите «Привязать Telegram» — код должен создаться, и вы сможете отправить его боту командой `/link_КОД`.
